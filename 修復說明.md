# 系統修復說明

## 🐛 修復的問題

### 問題 1：查詢給付標準 API 返回 422 錯誤

**錯誤訊息：**
```
Failed to load resource: the server responded with a status of 422 (Unprocessable Content)
```

**根本原因：**
- 前端調用 API 時，`injury_type` 參數傳送 `null` 值
- 後端 Pydantic 模型驗證失敗，返回 422 錯誤

**修復方案：**
```javascript
// 修改前
getDisabilityBenefit: (level, injuryType = null) =>
  api.post('/disability/benefit', { level, injury_type: injuryType }),

// 修改後
getDisabilityBenefit: (level, injuryType = '普通傷病') =>
  api.post('/disability/benefit', { level: parseInt(level), injury_type: injuryType }),
```

**改進：**
- ✅ 設置默認值為 `'普通傷病'`（符合後端驗證規則）
- ✅ 確保 `level` 轉換為整數類型
- ✅ 傳送完整的必要參數

---

### 問題 2：地圖關閉詳細視窗後位置跑掉

**問題描述：**
- 點擊醫院或辦事處，地圖平滑跳轉到該位置 ✅
- 關閉詳細資料視窗後，地圖位置重置回原點 ❌

**根本原因：**
- 關閉對話框時清除了選中位置的狀態
- 導致地圖重新計算邊界，返回初始視圖

**修復方案：**
```javascript
// 修改前
<Dialog
  open={dialogOpen}
  onClose={() => setDialogOpen(false)}
  ...
>

// 修改後
<Dialog
  open={dialogOpen}
  onClose={() => {
    setDialogOpen(false);
    // 不清除 selectedLocation 和 mapSelectedLocation，保持地圖位置
  }}
  ...
>
```

**改進：**
- ✅ 關閉視窗時只關閉對話框，不清除位置狀態
- ✅ 保持地圖在選中的醫院/辦事處位置
- ✅ 用戶體驗更流暢

---

## 📝 測試方法

### 測試查詢給付標準：
1. 進入「點身健檢」頁面
2. 選擇任一器官（如「左手」）
3. 描述傷害情況
4. 點擊「分析可能的失能等級」
5. 選擇失能等級（如「第 7 級」）
6. 點擊「查詢給付標準」
7. ✅ 應該正常顯示給付標準（不再出現 422 錯誤）

### 測試地圖位置保持：
1. 進入「地圖搜索」頁面
2. 點擊「獲取我的位置」
3. 點擊列表中的任一醫院
4. ✅ 地圖平滑跳轉到該醫院位置
5. 查看詳細資料
6. 點擊「關閉」按鈕
7. ✅ 地圖應該保持在該醫院位置（不會跑掉）

---

## 🎯 技術細節

### API 參數類型
- `level`: `int` (1-15)
- `injury_type`: `str` ('普通傷病', '職業傷病', '職業災害', '職業', '普通')

### 後端驗證
```python
class DisabilityBenefitRequest(BaseModel):
    level: int = Field(..., ge=1, le=15, description="失能等級 (1-15)")
    injury_type: str = Field(default="普通傷病", description="傷病類型")
```

### 前端狀態管理
- `dialogOpen`: 控制對話框顯示/隱藏
- `selectedLocation`: 選中的位置資訊（保持不變）
- `mapSelectedLocation`: 地圖中心位置（保持不變）

---

**修復日期**：2025-10-21  
**修復文件**：
- `frontend/src/services/api.js`
- `frontend/src/pages/MapPage.js`

**測試狀態**：✅ 已驗證通過

